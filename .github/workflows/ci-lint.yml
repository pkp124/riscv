# =============================================================================
# CI Pipeline: Lint and Format Checks
# =============================================================================
# Lightweight workflow that runs on every push/PR for fast feedback.
# =============================================================================

name: CI - Lint

on:
  push:
    paths:
      - 'app/**'
      - '.clang-format'
      - '.clang-tidy'
  pull_request:
    paths:
      - 'app/**'
      - '.clang-format'
      - '.clang-tidy'

jobs:
  format-check:
    name: "Format Check"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          if find app/ -name '*.c' -o -name '*.h' 2>/dev/null | head -1 | grep -q .; then
            RESULT=0
            while IFS= read -r file; do
              if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
                echo "FAIL: $file needs formatting"
                RESULT=1
              fi
            done < <(find app/ -name '*.c' -o -name '*.h')
            if [ "$RESULT" -ne 0 ]; then
              echo ""
              echo "Run 'make format' to fix formatting issues."
              exit 1
            fi
            echo "All files properly formatted."
          else
            echo "No C source files found yet."
          fi

  static-analysis:
    name: "Static Analysis"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          if [ -d "app/src" ] && find app/src -name '*.c' 2>/dev/null | head -1 | grep -q .; then
            cppcheck \
              --enable=warning,style,performance,portability \
              --std=c11 \
              --suppress=missingIncludeSystem \
              --suppress=unusedFunction \
              --suppress=knownConditionTrueFalse \
              --inline-suppr \
              --error-exitcode=1 \
              --xml --xml-version=2 \
              -I app/include/ \
              app/src/ 2> cppcheck-report.xml
            echo "cppcheck passed."
          else
            echo "No C source files found yet."
          fi

      - name: Upload cppcheck report
        if: always() && hashFiles('cppcheck-report.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 14
